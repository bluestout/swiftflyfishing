{% assign product_found = false %}
{% assign skip = false %}
{% assign collection_group = products | map: 'id' %}
{% assign collection_group_thumb = collection_group | append : 'thumb' %}
{% assign collection_group_mobile = collection_group | append : 'mobile' %}

{% if template contains 'collection' %}
  {% assign matrixType = 'collection-matrix' %}
{% elsif template contains 'search' %}
  {% assign matrixType = 'search-matrix' %}
{% endif %}

{% assign forLimit = limit %}

{% unless template contains 'product' %}
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "ItemList",
      "itemListElement": [
        {% for product in products limit: limit %}
          {
            "@type": "ListItem",
            "position": "{{ forloop.index | json }}",
            "url": "{{ shop.url }}{{ product.url }}",
            "name": "{{ product.title | escape }}"
          } {%- unless forloop.last -%},{%- endunless -%}
        {% endfor %}
      ]
    }
  </script>
{% endunless %}

{% for product in products limit: limit %}
  {% if product.id == skip_product.id  %}
    {% assign forLimit = limit | plus: 1 %}
  {% endif %}
{% endfor %}
{% assign status = false %}
{% for item in products limit: forLimit %}
    {% if type == 'block' %}
      {% assign product = all_products[item.settings.product] %}
    {% else %}
      {% assign product = item %}
    {% endif %}
    {% for tag in product.tags %}
      {% if product.id != skip_product.id and tag == 'FastGlass' %}
        {% assign status = true %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endfor %}
{% if status %}
<div class='separate_heading_block'>
  {% if collection.handle == 'fly-rod-building-kits' %}
  <h2 class="uppercase">{{ 'collections.general.fly-rod-building-kits_Fastglass__heading' | t }}</h2>
  <p>{{ 'collections.general.fly-rod-building-kits_Fastglass__subtitle' | t }}</p>
  {% elsif collection.handle == 'custom_fly_rods' %}
  <h2 class="uppercase">{{ 'collections.general.custom_fly_rods_Fastglass__heading' | t }}</h2>
  <p>{{ 'collections.general.custom_fly_rods_Fastglass__subtitle' | t }}</p>
  {% endif %}
</div>
{% endif %}

<div itemtype="http://schema.org/ItemList" class="product-list {{ matrixType }} clearfix equal-columns--clear equal-columns--outside-trim">
  {% for item in products limit: forLimit %}
    {% if type == 'block' %}
      {% assign product = all_products[item.settings.product] %}
    {% else %}
      {% assign product = item %}
    {% endif %}
    {% for tag in product.tags %}
      {% if product.id != skip_product.id and tag == 'FastGlass' %}
      
        {% render 'product-thumbnail',
                product: product,
                products_per_row: products_per_row,
                collection_group_thumb: collection_group_thumb,
                collection_group_mobile: collection_group_mobile,
                sidebar: sidebar
        %}
      {% endif %}
    {% endfor %}
  {% endfor %}
  {% if template contains 'collection' %}
    {% if settings.pagination_type == 'load_more' or settings.pagination_type == 'infinite_scroll' %}
      {% if paginate.next.url %}
        <span class="js-load-more load-more">
          <a href="{{ paginate.next.url }}" data-no-instant class="load-more__btn action_button continue-button">
            {% if template contains 'collection' %}
              {{ 'collections.general.load_more' | t }}
            {% elsif template contains 'search' %}
              {{ 'general.search.load_more' | t }}
            {% endif %}
          </a>
        </span>
      {% endif %}
    {% endif %}
  {% elsif template contains 'search' %}
    {% if settings.search_pagination_type == 'load_more' or settings.search_pagination_type == 'infinite_scroll' %}
      {% if paginate.next.url %}
        <span class="js-load-more load-more">
          <a href="{{ paginate.next.url }}" data-no-instant class="load-more__btn action_button continue-button">
            {% if template contains 'collection' %}
              {{ 'collections.general.load_more' | t }}
            {% elsif template contains 'search' %}
              {{ 'general.search.load_more' | t }}
            {% endif %}
          </a>
        </span>
      {% endif %}
    {% endif %}
  {% endif %}
</div>
{% assign status = false %}
{% for item in products limit: forLimit %}
    {% if type == 'block' %}
      {% assign product = all_products[item.settings.product] %}
    {% else %}
      {% assign product = item %}
    {% endif %}
    {% for tag in product.tags %}
    {% if product.id != skip_product.id and tag == 'Carbon Fibre' %}
        {% assign status = true %}
        {% break %}
    {% endif %}
    {% endfor %}
  {% endfor %}

{% if status %}
<div class='separate_heading_block'>
  {% if collection.handle == 'fly-rod-building-kits' %}
  <h2 class="uppercase">{{ 'collections.general.fly-rod-building-kits_Carbon_Fibre__heading' | t }}</h2>
  <p>{{ 'collections.general.fly-rod-building-kits_Carbon_Fibre__subtitle' | t }}</p>
  {% elsif collection.handle == 'custom_fly_rods' %}
  <h2 class="uppercase">{{ 'collections.general.custom_fly_rods_Carbon_Fibre__heading' | t }}</h2>
  <p>{{ 'collections.general.custom_fly_rods_Carbon_Fibre__subtitle' | t }}</p>
  {% endif %}
</div>
{% endif %}

<div itemtype="http://schema.org/ItemList" class="product-list {{ matrixType }} clearfix equal-columns--clear equal-columns--outside-trim">
  {% for item in products limit: forLimit %}
    {% if type == 'block' %}
      {% assign product = all_products[item.settings.product] %}
    {% else %}
      {% assign product = item %}
    {% endif %}
    {% for tag in product.tags %}
    {% if product.id != skip_product.id and tag == 'Carbon Fibre' %}
      {% render 'product-thumbnail',
              product: product,
              products_per_row: products_per_row,
              collection_group_thumb: collection_group_thumb,
              collection_group_mobile: collection_group_mobile,
              sidebar: sidebar
      %}
    {% endif %}
    {% endfor %}
  {% endfor %}
  {% if template contains 'collection' %}
    {% if settings.pagination_type == 'load_more' or settings.pagination_type == 'infinite_scroll' %}
      {% if paginate.next.url %}
        <span class="js-load-more load-more">
          <a href="{{ paginate.next.url }}" data-no-instant class="load-more__btn action_button continue-button">
            {% if template contains 'collection' %}
              {{ 'collections.general.load_more' | t }}
            {% elsif template contains 'search' %}
              {{ 'general.search.load_more' | t }}
            {% endif %}
          </a>
        </span>
      {% endif %}
    {% endif %}
  {% elsif template contains 'search' %}
    {% if settings.search_pagination_type == 'load_more' or settings.search_pagination_type == 'infinite_scroll' %}
      {% if paginate.next.url %}
        <span class="js-load-more load-more">
          <a href="{{ paginate.next.url }}" data-no-instant class="load-more__btn action_button continue-button">
            {% if template contains 'collection' %}
              {{ 'collections.general.load_more' | t }}
            {% elsif template contains 'search' %}
              {{ 'general.search.load_more' | t }}
            {% endif %}
          </a>
        </span>
      {% endif %}
    {% endif %}
  {% endif %}
</div>
<div class="load-more__icon"></div>
